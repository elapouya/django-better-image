/*
 django-better-image javascript for widget
 https://github.com/elapouya/django-better-image

 Copyright 2019, Eric Lapouyade
 Released under the LGPL license
*/
'use strict';(function(d){function v(b,t,p){function l(b){let c=b.getCanvasData();var a=b.getContainerData();c.height=c.height*a.width/c.width;c.width=a.width;c.left=0;c.top=(a.height-c.height)/2;c.height>a.height&&(c.width=c.width*a.height/c.height,c.height=a.height,c.top=0,c.left=(a.width-c.width)/2);a=b.options.autoCropArea;b.setCanvasData({top:c.top,left:c.left,width:c.width,height:c.height});b.setCropBoxData({top:c.top+c.height*(1-a)/2,left:c.left+c.width*(1-a)/2,height:c.height*a,width:c.width*
a})}function n(a,c){const b=a.getCanvasData();var d=a.getContainerData();let g=a.getCropBoxData();void 0===g.width&&(g={top:0,left:0,width:d.width,height:d.height});let u=b.left+b.width/2,A=b.top+b.height/2,B=g.left+g.width/2,q=g.top+g.height/2,e=d.width/2;d=d.height/2;a.options.viewMode=0;a.setCanvasData({top:d-(d-A)*c-b.height*c/2+(d-q)*c,left:e-(e-u)*c-b.width*c/2+(e-B)*c,height:b.height*c,width:b.width*c});a.setCropBoxData({top:d-g.height*c/2,left:e-g.width*c/2,height:g.height*c,width:g.width*
c});a.options.viewMode=1}const h=d("#BetterImageCropDialogModal"),k=d("#BetterImageCropDialogModal .crop-save-button"),r=b.find(".upload-image"),f=b.find(".crop-preview");let m=b.attr("data-aspect-ratio");m="None"===m?NaN:parseFloat(m);let e=b.attr("data-autocrop-area");e="None"===e?0:parseInt(e)/100;let a=null;h.find("div.modal-body-crop").html('<img class="pic-to-edit" src="'+t+'">');d("#BetterImageCropDialogModal").on("shown.bs.modal",function(){function b(){a.destroy();a.init()}function c(){k.text(k.attr("data-save-label"));
a.clear()}var f=h.find("img.pic-to-edit");f.cropper({viewMode:1,aspectRatio:m,autoCropArea:e,autoCrop:0!==e});a=f.data("cropper");f.on("cropstart",function(){k.text(k.attr("data-crop-label"))});window._prev_cropper_orientation_change_listener&&window.removeEventListener("orientationchange",window._prev_cropper_orientation_change_listener,!1);window.addEventListener("orientationchange",b,!1);window._prev_cropper_orientation_change_listener=b;h.find("div.action-group button").off("click").on("click",
function(){const b=d(this).attr("data-action");let e=a.getData();switch(b){case "crop":c();a.setDragMode("crop");h.find('button[data-action="crop"]').removeClass("btn-default").addClass("btn-success");h.find('button[data-action="move"]').removeClass("btn-success").addClass("btn-default");break;case "move":c();a.setDragMode("move");h.find('button[data-action="move"]').removeClass("btn-default").addClass("btn-success");h.find('button[data-action="crop"]').removeClass("btn-success").addClass("btn-default");
break;case "zoom-in":n(a,1.5);break;case "zoom-out":n(a,1/1.5);break;case "rotate-left":a.options.viewMode=0;a.rotate(-90);l(a);a.options.viewMode=1;break;case "rotate-right":a.options.viewMode=0;a.rotate(90);l(a);a.options.viewMode=1;break;case "flip-horizontal":a.scaleX(-e.scaleX);l(a);break;case "flip-vertical":a.scaleY(-e.scaleY);l(a);break;case "reset":a.reset(),c()}})});k.text(k.attr("data-save-label"));d("#BetterImageCropDialogModal").modal({backdrop:"static",keyboard:!1});d("#BetterImageCropDialogModal .btn-yes").off("click").on("click",
function(){if(a){let c=a.getData();var b=a.getImageData();c.imgWidth=b.naturalWidth;c.imgHeight=b.naturalHeight;f&&(r.addClass("hidden"),f.removeClass("hidden"),a.cropped||(a.crop(),b=a.getCanvasData(),a.setCropBoxData({top:b.top,left:b.left,width:b.width,height:b.height})),a.options.preview=f,a.initPreview(),a.preview(),a.options.preview=null);p(!0,c)}else p(!1,null);d("#BetterImageCropDialogModal").modal("hide")});d("#BetterImageCropDialogModal .btn-no").off("click").on("click",function(){p(!1,
null);d("#BetterImageCropDialogModal").modal("hide")})}function r(b){function t(b){setTimeout(function(){b.biw_tooltip.tooltip("show");setTimeout(function(){b.biw_tooltip.tooltip("hide");b.biw_tooltip.tooltip("dispose");b.biw_tooltip=null},3E3)},300)}function p(b,a){const c=b.attr("data-saved-tooltip");c&&(a=b.find(a).first(),b.biw_tooltip=b.tooltip({title:c,placement:"right",delay:{show:1E3,hide:1E3},template:'<div class="tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner better-image-widget"></div></div>'}),
a.on("load",function(){t(b)}))}function l(b){const a=b.attr("data-remember-tooltip");a&&(console.log("create tooltip..."),b.biw_tooltip=b.tooltip({title:a,placement:"right",delay:{show:1E3,hide:1E3},template:'<div class="tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner better-image-widget"></div></div>'}),t(b))}const n=b.find(".upload-button"),h=0!==n.length,k=b.find(".clear-button"),y=b.find(".edit-button"),f=b.find(".upload-image"),m=b.find(".image-data"),e=b.find("img.thumb"),
a=b.find(".crop-preview"),q=b.find(".input-file"),c=b.find(".dropzone"),x=b.find(".image-buttons"),z="True"===b.attr("data-crop-on-upload")?!0:!1;var g=!1;b.biw_tooltip=null;n.on("click",function(){q.val("");q.click();return!1});k.on("click",function(){if(h)x.addClass("hidden"),f.addClass("hidden"),a.addClass("hidden"),q.val(""),n.show();else{b.biw_tooltip&&b.biw_tooltip.tooltip("dispose");let a=k.attr("data-confirm-msg");a||(a="Do you confirm ?");djModalsConfirm(a,function(a){a&&(data={csrfmiddlewaretoken:w,
upload_params:b.attr("data-upload-params"),upload_params_chk:b.attr("data-upload-params-chk")},url=k.attr("data-post-url"),d.post(url,data,function(a){new_container=d(a.replace_html);b.replaceWith(new_container);r(new_container);{a=new_container;const b=a.attr("data-cleared-tooltip");b&&(a.biw_tooltip=a.tooltip({title:b,placement:"right",delay:{show:1E3,hide:1E3},template:'<div class="tooltip" role="tooltip"><div class="arrow"></div><div class="tooltip-inner better-image-widget"></div></div>'}),t(a))}}))})}return!1});
y.on("click",function(){if(h)v(b,f.attr("src"),function(a,c){a&&(m.val(JSON.stringify(c)),l(b))});else{b.biw_tooltip&&b.biw_tooltip.tooltip("dispose");const a=e.attr("data-image-url");v(b,a,function(a,c){a&&(c=d.extend(c,{csrfmiddlewaretoken:w,upload_params:b.attr("data-upload-params"),upload_params_chk:b.attr("data-upload-params-chk")}),url=y.attr("data-post-url"),a=e.attr("data-img-processing"),e.loading({message:a}),d.post(url,c,function(a){e.loading("stop");new_container=d(a.replace_html);b.replaceWith(new_container);
r(new_container);p(new_container,"img.thumb")}))})}return!1});q.on("change",function(c){let d=g?300:1;f.animate({opacity:0},d);setTimeout(function(){let d=0;for(d=0;d<c.originalEvent.srcElement.files.length;d++){let e=c.originalEvent.srcElement.files[d],u=new FileReader;u.onloadend=function(){g=!0;f.attr("src",u.result).animate({opacity:1},700);m.val("");n.hide();x.removeClass("hidden");z?v(b,f.attr("src"),function(a,c){m.val(JSON.stringify(c));l(b)}):l(b)};u.readAsDataURL(e);f.removeClass("hidden");
a.addClass("hidden")}},d)});c.dropzone({url:c.attr("data-post-url"),paramName:b.attr("data-field-name"),timeout:3E5,thumbnailWidth:parseInt(b.attr("data-dz-thumb-width")),thumbnailHeight:parseInt(b.attr("data-dz-thumb-height")),sending:function(a,c,d){d.append("csrfmiddlewaretoken",w);d.append("upload_params",b.attr("data-upload-params"));d.append("upload_params_chk",b.attr("data-upload-params-chk"))},success:function(a,c){a=d(c.replace_html);b.replaceWith(a);r(a);p(a,"img.thumb")}});e.on("drop",
function(a){a.preventDefault();a.stopPropagation();djModalsAlert("Please clear image first")});e.on("dragover dragleave",function(a){a.preventDefault();a.stopPropagation()})}var w=Cookies.get("csrftoken");d(document).ready(function(){d(".better-image-widget-container").each(function(){const b=d(this);r(b)})})})(jQuery);
